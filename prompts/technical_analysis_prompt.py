"""
í•œêµ­ ì£¼ì‹ ì‹œì¥ íŠ¹í™” ê¸°ìˆ ì  ë¶„ì„ í”„ë¡¬í”„íŠ¸
"""
from typing import Dict, Any
from datetime import datetime


def create_technical_analysis_prompt(
    strategy_result: Dict[str, Any],
    analysis_type: str = "detailed"
) -> str:
    """
    í•œêµ­ ì£¼ì‹ ì‹œì¥ íŠ¹í™” ê¸°ìˆ ì  ë¶„ì„ í”„ë¡¬í”„íŠ¸ ìƒì„±

    Args:
        strategy_result: ì „ëµ ë¶„ì„ ê²°ê³¼
        analysis_type: ë¶„ì„ íƒ€ì… (detailed, summary, trading_signal)

    Returns:
        í•œêµ­ ì‹œì¥ íŠ¹í™” ê¸°ìˆ ì  ë¶„ì„ í”„ë¡¬í”„íŠ¸
    """
    strategy_name = strategy_result.get('strategy_name', 'Unknown')
    matches_found = strategy_result.get('matches_found', 0)
    results = strategy_result.get('results', [])
    total_analyzed = strategy_result.get('total_analyzed', 0)

    # ì „ëµë³„ í•œêµ­ ì‹œì¥ íŠ¹í™” ì„¤ëª…
    strategy_descriptions = {
        'dictmacdgoldencrossstrategy': {
            'name': 'MACD ê³¨ë“ í¬ë¡œìŠ¤',
            'korean_context': 'KOSPI/KOSDAQì—ì„œ ì™¸êµ­ì¸ ë§¤ìˆ˜ ì‹¬ë¦¬ì™€ ê¸°ê´€ íˆ¬ìì ìœ ì…ì„ ë‚˜íƒ€ë‚´ëŠ” ëŒ€í‘œì ì¸ ê°•ì„¸ ì‹ í˜¸',
            'market_timing': 'í•œêµ­ ì‹œì¥ íŠ¹ì„±ìƒ ì˜¤ì „ 9ì‹œ~11ì‹œ, ì˜¤í›„ 2ì‹œ~3ì‹œ ê±°ë˜ëŸ‰ ì¦ê°€ ì‹œì ê³¼ ì—°ê³„í•˜ì—¬ ë¶„ì„'
        },
        'dictrsioversoldstrategy': {
            'name': 'RSI ê³¼ë§¤ë„ ë°˜ë“±',
            'korean_context': 'í•œêµ­ íˆ¬ììë“¤ì˜ ê³µí¬ ë§¤ë„ í›„ ê¸°ìˆ ì  ë°˜ë“±ì„ í¬ì°©í•˜ëŠ” ì „ëµìœ¼ë¡œ, íŠ¹íˆ ì¤‘ì†Œí˜•ì£¼ì—ì„œ íš¨ê³¼ì ',
            'market_timing': 'ì›”ë§/ë¶„ê¸°ë§ ë¦¬ë°¸ëŸ°ì‹±ê³¼ ì—°ê³„ëœ ë§¤ìˆ˜ íƒ€ì´ë° ë¶„ì„ì´ ì¤‘ìš”'
        },
        'dictbollingersqueezestrategy': {
            'name': 'ë³¼ë¦°ì € ë°´ë“œ ìŠ¤í€´ì¦ˆ',
            'korean_context': 'í•œêµ­ ì‹œì¥ì˜ ë°•ìŠ¤ê¶Œ íš¡ë³´ í›„ ê¸‰ë“±/ê¸‰ë½ íŒ¨í„´ì„ ì˜ˆì¸¡í•˜ëŠ” ë³€ë™ì„± ëŒíŒŒ ì „ëµ',
            'market_timing': 'ì‹¤ì  ë°œí‘œ ì‹œì¦Œê³¼ ì •ì±… ë°œí‘œ ì „í›„ ë³€ë™ì„± í™•ëŒ€ êµ¬ê°„ì—ì„œ íŠ¹íˆ ìœ ì˜ë¯¸'
        },
        'dictmovingaveragecrossoverstrategy': {
            'name': 'ì´ë™í‰ê· ì„  êµì°¨',
            'korean_context': 'í•œêµ­ ê°œì¸íˆ¬ììë“¤ì´ ê°€ì¥ ì„ í˜¸í•˜ëŠ” ê¸°ìˆ ì  ë¶„ì„ ì‹ í˜¸ë¡œ, ëŒ€ì¤‘ì  ë§¤ë§¤ ì‹¬ë¦¬ ë°˜ì˜',
            'market_timing': 'ì½”ìŠ¤í”¼ ì§€ìˆ˜ì™€ì˜ ë™ì¡°í™” í˜„ìƒ ë° ì„¹í„° ë¡œí…Œì´ì…˜ ê´€ì ì—ì„œ ë¶„ì„'
        }
    }

    current_strategy = strategy_descriptions.get(strategy_name, {
        'name': strategy_name,
        'korean_context': 'í•œêµ­ ì£¼ì‹ ì‹œì¥ ë§ì¶¤í˜• ë¶„ì„',
        'market_timing': 'í•œêµ­ ì‹œì¥ ê±°ë˜ íŒ¨í„´ ê³ ë ¤ ë¶„ì„'
    })

    prompt = f"""ë‹¹ì‹ ì€ í•œêµ­ ì£¼ì‹ ì‹œì¥ì„ 15ë…„ ì´ìƒ ë¶„ì„í•´ì˜¨ ì „ë¬¸ ê¸°ìˆ ì  ë¶„ì„ê°€ì…ë‹ˆë‹¤.
KOSPIì™€ KOSDAQì˜ ê³ ìœ í•œ íŠ¹ì„±ì„ ê¹Šì´ ì´í•´í•˜ê³  ìˆìœ¼ë©°, í•œêµ­ íˆ¬ììë“¤ì˜ ì‹¬ë¦¬ì™€ ê±°ë˜ íŒ¨í„´ì— ì •í†µí•©ë‹ˆë‹¤.

## ğŸ“Š ê¸°ìˆ ì  ë¶„ì„ ê°œìš”
**ë¶„ì„ ì „ëµ**: {current_strategy['name']}
**í•œêµ­ ì‹œì¥ ë§¥ë½**: {current_strategy['korean_context']}
**ì‹œì¥ íƒ€ì´ë°**: {current_strategy['market_timing']}

## ğŸ“ˆ ë¶„ì„ ê²°ê³¼ ìš”ì•½
- **ì¡°ê±´ ë§Œì¡± ì¢…ëª©**: {matches_found}ê°œ (ì´ {total_analyzed}ê°œ ë¶„ì„)
- **ë¶„ì„ ì‹œì **: {datetime.now().strftime('%Yë…„ %mì›” %dì¼ %Hì‹œ %Më¶„')} KST
- **ì‹œì¥ ìƒí™©**: {"ì¥ì¤‘" if 9 <= datetime.now().hour <= 15 else "ì¥í›„"}

## ğŸ¯ ë°œê²¬ëœ íˆ¬ì ê¸°íšŒ:"""

    if not results:
        prompt += """
í˜„ì¬ ì„¤ì •ëœ ê¸°ìˆ ì  ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤.

### ğŸ” ëŒ€ì•ˆ ë¶„ì„
1. **ì „ëµ ë§¤ê°œë³€ìˆ˜ ì¡°ì •**: í˜„ì¬ ì¡°ê±´ì´ ê³¼ë„í•˜ê²Œ ì—„ê²©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
2. **ì‹œì¥ í™˜ê²½ ê³ ë ¤**: í˜„ì¬ ì‹œì¥ì´ íš¡ë³´ ë˜ëŠ” ì•½ì„¸ êµ¬ê°„ì¼ ê°€ëŠ¥ì„±
3. **ì„¹í„°ë³„ ë¶„ì„**: íŠ¹ì • ì—…ì¢…ì—ì„œ ê¸°íšŒ íƒìƒ‰ ê¶Œì¥
4. **ë³µí•© ì „ëµ**: ë‹¤ë¥¸ ê¸°ìˆ ì  ì§€í‘œì™€ì˜ ì¡°í•© ê³ ë ¤

**ì¶”ì²œ í–‰ë™**: ì „ëµ ì¡°ê±´ì„ ì™„í™”í•˜ê±°ë‚˜ ë‹¤ë¥¸ ì‹œê°„ëŒ€ì— ì¬ë¶„ì„ì„ ê¶Œì¥í•©ë‹ˆë‹¤."""
        return prompt

    for i, result in enumerate(results[:5], 1):
        ticker = result.get('ticker', 'N/A')
        signal_strength = result.get('signal_strength', 0)
        current_price = result.get('current_price', 0)
        analysis_date = result.get('date', 'N/A')

        # ì‹ í˜¸ ê°•ë„ì— ë”°ë¥¸ í•œêµ­ì–´ í‘œí˜„
        strength_desc = "ë§¤ìš° ê°•í•¨" if signal_strength >= 0.9 else "ê°•í•¨" if signal_strength >= 0.7 else "ë³´í†µ"

        prompt += f"""

### {i}. ğŸ“Œ {ticker} (ì‹ í˜¸ê°•ë„: {signal_strength:.3f} - {strength_desc})
- **í˜„ì¬ê°€**: {current_price:,}ì›
- **ë¶„ì„ì¼**: {analysis_date}
- **ê¸°ìˆ ì  ìƒíƒœ**: {_get_technical_status(signal_strength)}
- **í•œêµ­ ì‹œì¥ í¬ì§€ì…˜**: {_get_market_position(current_price)}"""

    if analysis_type == "detailed":
        prompt += f"""

## ğŸ”¬ ìƒì„¸ ê¸°ìˆ ì  ë¶„ì„

### 1. ì¢…ëª©ë³„ íˆ¬ì ë§¤ë ¥ë„
ê° ì¢…ëª©ì˜ ê¸°ìˆ ì  ì§€í‘œ í•´ì„ê³¼ í•œêµ­ ì‹œì¥ íŠ¹ì„±ì„ ê³ ë ¤í•œ ë§¤ë ¥ë„ë¥¼ í‰ê°€í•´ì£¼ì„¸ìš”:
- **ê±°ë˜ëŸ‰ íŒ¨í„´**: ì™¸êµ­ì¸/ê¸°ê´€/ê°œì¸ ë§¤ë§¤ ë™í–¥ ì¶”ì •
- **ê°€ê²© ëª¨ë©˜í…€**: í•œêµ­ ì‹œì¥ íŠ¹ìœ ì˜ ê¸‰ë“±/ê¸‰ë½ íŒ¨í„´ ë¶„ì„
- **ì„¹í„° ê°•ë„**: ì—…ì¢…ë³„ ìê¸ˆ íë¦„ê³¼ ì—°ê³„ ë¶„ì„

### 2. ì‹œì¥ í™˜ê²½ í•´ì„
- **ì½”ìŠ¤í”¼ ì§€ìˆ˜ ì—°ë™ì„±**: ì‹œì¥ ì „ì²´ ë°©í–¥ì„±ê³¼ì˜ ìƒê´€ê´€ê³„
- **ê±°ë˜ ì‹œê°„ëŒ€ë³„ íŠ¹ì„±**: 9-11ì‹œ(ì˜¤ì „ ì¥), 13-15ì‹œ(ì˜¤í›„ ì¥) íŒ¨í„´
- **í•´ì™¸ ì‹œì¥ ì˜í–¥**: ë¯¸êµ­, ì¤‘êµ­ ì¦ì‹œ ë™í–¥ ë°˜ì˜ë„

### 3. íˆ¬ì ì „ëµ ìˆ˜ë¦½
- **ì§„ì… ì‹œì **: ìµœì  ë§¤ìˆ˜ íƒ€ì´ë°ê³¼ ë¶„í•  ë§¤ìˆ˜ ì „ëµ
- **ëª©í‘œê°€ ì„¤ì •**: ê¸°ìˆ ì  ì €í•­ì„  ê¸°ë°˜ ëª©í‘œê°€ ì‚°ì •
- **ì†ì ˆ ê¸°ì¤€**: ì§€ì§€ì„  ì´íƒˆ ì‹œ ì†ì ˆë§¤ ê¸°ì¤€

### 4. ë¦¬ìŠ¤í¬ ê´€ë¦¬
- **ì‹œì¥ ë¦¬ìŠ¤í¬**: í•œêµ­ ì‹œì¥ ê³ ìœ ì˜ ë³€ë™ì„± ìš”ì¸
- **ì¢…ëª© ë¦¬ìŠ¤í¬**: ê°œë³„ ì¢…ëª©ì˜ ê¸°ì—… íŠ¹ìˆ˜ ìƒí™©
- **ì •ì±… ë¦¬ìŠ¤í¬**: ì •ë¶€ ì •ì±… ë° ê·œì œ ë³€í™” ì˜í–¥

### 5. í¬íŠ¸í´ë¦¬ì˜¤ êµ¬ì„±
- **ë¹„ì¤‘ ì¡°ì ˆ**: ì‹ í˜¸ ê°•ë„ë³„ íˆ¬ì ë¹„ì¤‘ ì œì•ˆ
- **ë¶„ì‚° íš¨ê³¼**: ì„¹í„°/ì‹œê°€ì´ì•¡ë³„ ë¶„ì‚° íˆ¬ì ë°©ì•ˆ
- **ë¦¬ë°¸ëŸ°ì‹±**: ìˆ˜ìµë¥ ì— ë”°ë¥¸ í¬ì§€ì…˜ ì¡°ì • ì‹œì 

**ëª¨ë“  ë¶„ì„ì€ í•œêµ­ íˆ¬ììì˜ ì‹¤ì „ ë§¤ë§¤ì— ë„ì›€ì´ ë˜ë„ë¡ êµ¬ì²´ì ì´ê³  ì‹¤ìš©ì ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.**"""

    elif analysis_type == "summary":
        prompt += f"""

## ğŸ’¡ í•µì‹¬ íˆ¬ì í¬ì¸íŠ¸

ë‹¤ìŒ ê´€ì ì—ì„œ ê°„ê²°í•˜ê³  ëª…í™•í•˜ê²Œ ë¶„ì„í•´ì£¼ì„¸ìš”:

### ğŸ¯ íˆ¬ì ì¶”ì²œ ìš°ì„ ìˆœìœ„
ì‹ í˜¸ ê°•ë„ì™€ í•œêµ­ ì‹œì¥ íŠ¹ì„±ì„ ê³ ë ¤í•œ ì¢…ëª©ë³„ íˆ¬ì ë§¤ë ¥ë„ ìˆœìœ„ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.

### ğŸ“Š ê¸°ìˆ ì  ì‹ í˜¸ í•´ì„
í˜„ì¬ ê¸°ìˆ ì  íŒ¨í„´ì´ í•œêµ­ ì‹œì¥ì—ì„œ ê°–ëŠ” ì˜ë¯¸ì™€ ì„±ê³µ í™•ë¥ ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.

### â° íˆ¬ì íƒ€ì´ë°
í•œêµ­ ì‹œì¥ì˜ ê±°ë˜ íŒ¨í„´ì„ ê³ ë ¤í•œ ìµœì  ì§„ì… ì‹œì ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.

### âš ï¸ ì£¼ìš” ë¦¬ìŠ¤í¬
í˜„ì¬ ì‹œì¥ í™˜ê²½ì—ì„œ ì£¼ì˜í•´ì•¼ í•  ë¦¬ìŠ¤í¬ ìš”ì¸ì„ ê°„ë‹¨íˆ ìš”ì•½í•´ì£¼ì„¸ìš”.

**3-5ê°œ ë¬¸ì¥ìœ¼ë¡œ í•µì‹¬ë§Œ ê°„ê²°í•˜ê²Œ ì •ë¦¬í•´ì£¼ì„¸ìš”.**"""

    else:  # trading_signal
        prompt += f"""

## ğŸš¨ ë§¤ë§¤ ì‹ í˜¸ ë¶„ì„

### ğŸ“ˆ ì§„ì… ì‹ í˜¸ (ë§¤ìˆ˜)
- **ì¦‰ì‹œ ë§¤ìˆ˜**: ì‹ í˜¸ê°•ë„ 0.8 ì´ìƒ ì¢…ëª©ì˜ êµ¬ì²´ì  ë§¤ìˆ˜ íƒ€ì´ë°
- **ë¶„í•  ë§¤ìˆ˜**: ì‹ í˜¸ê°•ë„ 0.6-0.8 ì¢…ëª©ì˜ ë‹¨ê³„ì  ì§„ì… ì „ëµ
- **ê´€ë§**: ì‹ í˜¸ê°•ë„ 0.6 ë¯¸ë§Œ ì¢…ëª©ì˜ ì¶”ê°€ í™•ì¸ í¬ì¸íŠ¸

### ğŸ“‰ ì²­ì‚° ì‹ í˜¸ (ë§¤ë„)
- **ì´ìµ ì‹¤í˜„**: ëª©í‘œ ìˆ˜ìµë¥  ë‹¬ì„± ì‹œ ë§¤ë„ íƒ€ì´ë°
- **ì†ì ˆë§¤**: ê¸°ìˆ ì  ì§€ì§€ì„  ì´íƒˆ ì‹œ ì†ì ˆ ê¸°ì¤€
- **ë¶€ë¶„ ë§¤ë„**: ìˆ˜ìµ ë³´í˜¸ë¥¼ ìœ„í•œ ë‹¨ê³„ì  ë§¤ë„ ì „ëµ

### â° ì‹œê°„ëŒ€ë³„ ë§¤ë§¤ ì „ëµ
- **ì¥ ì‹œì‘ (9:00-9:30)**: ê°­ ìƒìŠ¹/í•˜ë½ ëŒ€ì‘ ë°©ì•ˆ
- **ì˜¤ì „ ì¥ (9:30-11:30)**: ì£¼ìš” ë§¤ë§¤ ì„¸ë ¥ ë™í–¥ íŒŒì•…
- **ì ì‹¬ ì‹œê°„ (11:30-13:00)**: í•´ì™¸ ì‹œì¥ ë™í–¥ ì ê²€
- **ì˜¤í›„ ì¥ (13:00-15:20)**: ë§ˆê° ëŒ€ë¹„ í¬ì§€ì…˜ ì¡°ì •
- **ì¥ ë§ˆê° (15:20-15:30)**: ë‹¹ì¼ ì„±ê³¼ í™•ì¸ ë° ë‚´ì¼ ì „ëµ

**ê° ì¢…ëª©ë³„ë¡œ êµ¬ì²´ì ì¸ ë§¤ìˆ˜/ë§¤ë„ ê°€ê²©ëŒ€ë¥¼ ì œì‹œí•´ì£¼ì„¸ìš”.**"""

    prompt += f"""

## ğŸ“‹ ì¶”ê°€ ê³ ë ¤ì‚¬í•­
- **ì—…ì¢… ë™í–¥**: í•´ë‹¹ ì„¹í„°ì˜ ìµœê·¼ ìê¸ˆ íë¦„
- **ì™¸êµ­ì¸ ë™í–¥**: ìµœê·¼ ì™¸êµ­ì¸ ë§¤ë§¤ íŒ¨í„´ ì˜í–¥
- **ê¸°ê´€ ë™í–¥**: ì—°ê¸°ê¸ˆ, ë³´í—˜ì‚¬ ë“± ê¸°ê´€íˆ¬ìì ì›€ì§ì„
- **ê°œì¸ ì‹¬ë¦¬**: ê°œë¯¸ íˆ¬ìì ë§¤ë§¤ íŒ¨í„´ê³¼ ì‹œì¥ ë¶„ìœ„ê¸°

**ë¶„ì„ ê²°ê³¼ëŠ” ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•˜ê³ , ì‹¤ì œ ë§¤ë§¤ì— í™œìš©í•  ìˆ˜ ìˆë„ë¡ êµ¬ì²´ì ì¸ ìˆ˜ì¹˜ì™€ í•¨ê»˜ ì œì‹œí•´ì£¼ì„¸ìš”.**"""

    return prompt


def _get_technical_status(signal_strength: float) -> str:
    """ì‹ í˜¸ ê°•ë„ì— ë”°ë¥¸ ê¸°ìˆ ì  ìƒíƒœ í•œêµ­ì–´ í‘œí˜„"""
    if signal_strength >= 0.9:
        return "ë§¤ìš° ê°•í•œ ë§¤ìˆ˜ ì‹ í˜¸ - ì¦‰ì‹œ ì§„ì… ê¶Œì¥"
    elif signal_strength >= 0.8:
        return "ê°•í•œ ë§¤ìˆ˜ ì‹ í˜¸ - ì ê·¹ ë§¤ìˆ˜ ê³ ë ¤"
    elif signal_strength >= 0.7:
        return "ì–‘í˜¸í•œ ë§¤ìˆ˜ ì‹ í˜¸ - ë¶„í•  ë§¤ìˆ˜ ê¶Œì¥"
    elif signal_strength >= 0.6:
        return "ë³´í†µ ë§¤ìˆ˜ ì‹ í˜¸ - ì‹ ì¤‘í•œ ì§„ì…"
    else:
        return "ì•½í•œ ì‹ í˜¸ - ì¶”ê°€ í™•ì¸ í•„ìš”"


def _get_market_position(price: float) -> str:
    """ê°€ê²©ëŒ€ì— ë”°ë¥¸ í•œêµ­ ì‹œì¥ í¬ì§€ì…˜ ë¶„ë¥˜"""
    if price >= 100000:
        return "ëŒ€í˜•ì£¼ (ì™¸êµ­ì¸/ê¸°ê´€ ì„ í˜¸)"
    elif price >= 50000:
        return "ì¤‘í˜•ì£¼ (ì•ˆì •ì„±ê³¼ ì„±ì¥ì„± ê· í˜•)"
    elif price >= 20000:
        return "ì¤‘ì†Œí˜•ì£¼ (ì„±ì¥ì„± ì¤‘ì‹¬)"
    elif price >= 5000:
        return "ì†Œí˜•ì£¼ (ë†’ì€ ë³€ë™ì„±)"
    else:
        return "ì €ê°€ì£¼ (ê³ ìœ„í—˜ ê³ ìˆ˜ìµ)"